<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>OrbisMesh - Connections</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root{
            --bg:#1a1a1a;
            --bg-2:#2d2d2d;
            --bg-3:#111;
            --text:#fff;
            --text2:#4caf50;
            --muted:#888;
            --brand:#4caf50;
            --danger:#f44336;
            --border:#444;
            --border2:#4caf50;
            --sidebar-w: 260px;
            --sidebar-w-collapsed: 76px;
        }

        /* ====== Reset / Base ====== */
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; background:var(--bg); color:var(--text);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            display:flex; min-height:100vh;
        }
        a{color:inherit; text-decoration:none}       

        /* ====== Main Area ====== */
        .main{
            flex:1; min-width:0; padding:16px; display:flex; flex-direction:column; gap:24px;
        }

        /* ====== Existing page styles (leicht angepasst) ====== */
        .header {
            display:flex; justify-content:space-between; align-items:stretch; gap:12px;
        }
        .logo-header img, .header img { height:60px; object-fit:contain }
        .section{
            background:var(--bg-2);
            padding:16px; border-radius:8px; margin:0;
        }
        .node-grid{
            display:grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
            gap:16px;
        }
        .node-card{
            background:var(--bg); padding:16px; border-radius:6px; transition:opacity .3s, background .3s;
        }
        .node-card.inactive{ background:#161616; opacity:.55; color:#666 }
        .status-indicator{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px }
        .status-active{ background:var(--brand) }
        .status-inactive{ background:var(--danger) }
        .stats{ font-size:14px; margin:8px 0 }
        .local-mac{ font-size:14px; color:#999 }

        /* Config styles kept for future reuse on this page */
        .config-controls{ display:flex; flex-direction:column; gap:16px }
        .current-config{ font-size:16px; padding:8px; background:var(--bg); border-radius:4px }
        .channel-selector{ display:flex; align-items:center; gap:12px }
        #channel-select{
            background:var(--bg); color:var(--text); border:1px solid var(--border);
            padding:8px; border-radius:4px;
        }
        #apply-channel{
            background:var(--brand); color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;
        }
        #apply-channel:hover{ filter:brightness(.95) }
        #apply-channel:disabled{ background:#666; cursor:not-allowed }
        .status-message{ padding:8px; border-radius:4px; display:none }
        .status-success{ background:var(--brand); color:#fff }
        .status-error{ background:var(--danger); color:#fff }

        @media (max-width: 720px){
        .sidebar{ position: fixed; left: 0; top: 0; }
        /* Content bleibt immer an der Position der eingeklappten Rail */
        .main{ padding: 16px 12px 24px calc(var(--sidebar-w-collapsed) + 12px); }
        /* KEINE Regel für ".sidebar:not(.collapsed) ~ .main" */
        }
        @media (min-width: 721px){
            .main{ padding:16px 24px 24px 24px }
        }
    </style>

    <script>

        // ====== --- Original WiFi page JS (unverändert) ======
        const WIFI_CHANNELS = {
            1:2412,2:2417,3:2422,4:2427,5:2432,6:2437,7:2442,8:2447,9:2452,10:2457,11:2462,12:2467,13:2472,14:2484,
            36:5180,40:5200,44:5220,48:5240,52:5260,56:5280,60:5300,64:5320,100:5500,104:5520,108:5540,112:5560,
            116:5580,120:5600,124:5620,128:5640,132:5660,136:5680,140:5700,144:5720,149:5745,153:5765,157:5785,161:5805,165:5825
        };

        function loadMeshConfig(){
            fetch('/api/mesh-config')
                .then(r=>r.json())
                .then(data=>{
                    const select = document.getElementById('channel-select');
                    if(!select) return; // (Auf dieser Seite derzeit nicht eingeblendet)
                    document.getElementById('current-channel').textContent = data.current_channel;
                    document.getElementById('current-frequency').textContent = data.current_frequency;

                    select.innerHTML='';
                    const ch24 = data.available_channels.filter(c=>c<=14);
                    const ch5  = data.available_channels.filter(c=>c>14);

                    if(ch24.length){
                        const g=document.createElement('optgroup'); g.label='2.4 GHz';
                        ch24.forEach(c=>{
                            const o=document.createElement('option');
                            o.value=c; o.textContent=`Channel ${c} (${WIFI_CHANNELS[c]} MHz)`;
                            if(c===data.current_channel) o.selected=true;
                            g.appendChild(o);
                        });
                        select.appendChild(g);
                    }
                    if(ch5.length){
                        const g=document.createElement('optgroup'); g.label='5 GHz';
                        ch5.forEach(c=>{
                            const o=document.createElement('option');
                            o.value=c; o.textContent=`Channel ${c} (${WIFI_CHANNELS[c]} MHz)`;
                            if(c===data.current_channel) o.selected=true;
                            g.appendChild(o);
                        });
                        select.appendChild(g);
                    }
                })
                .catch(()=>{ /* optional status */ });
        }

        function changeChannel(){
            const selected = parseInt(document.getElementById('channel-select').value);
            const current  = parseInt(document.getElementById('current-channel').textContent);
            if(selected===current){ showStatus('Channel is already set to '+selected,'error'); return; }
            if(!confirm(`Change mesh channel to ${selected}? This will restart the system and temporarily disconnect all nodes.`)) return;

            const btn=document.getElementById('apply-channel');
            btn.disabled=true; btn.textContent='Applying...';
            showStatus('Changing channel and rebooting system...','info');

            fetch('/api/mesh-config',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({channel:selected})})
              .then(r=>r.json())
              .then(d=>{
                if(d.success){ showStatus(d.message,'success'); }
                else{ showStatus(d.error || 'Failed to change channel','error'); btn.disabled=false; btn.textContent='Apply Channel';}
              })
              .catch(()=>{ showStatus('Failed to change channel','error'); btn.disabled=false; btn.textContent='Apply Channel';});
        }

        function showStatus(message,type){
            const el=document.getElementById('config-status');
            if(!el) return;
            el.textContent=message;
            el.className=`status-message status-${type}`;
            el.style.display='block';
            if(type!=='error'){ setTimeout(()=>{ el.style.display='none'; },5000); }
        }

        function updateData(){
            fetch('/api/wifi')
              .then(r=>r.json())
              .then(data=>{
                document.querySelector('h1').textContent = data.hostname;
                document.querySelector('.local-mac').textContent = 'Local MAC: ' + data.local_mac;

                const grid=document.querySelector('.node-grid');
                grid.innerHTML='';
                Object.entries(data.node_status).forEach(([mac,node])=>{
                    const inactive = node.last_seen > data.node_timeout;
                    grid.insertAdjacentHTML('beforeend', `
                        <div class="node-card ${inactive?'inactive':''}">
                            <h3><span class="status-indicator ${inactive?'status-inactive':'status-active'}"></span>${mac}</h3>
                            <div class="stats">Last Seen: ${Number(node.last_seen).toFixed(2)}s ago</div>
                            <div class="stats">Throughput: ${Number(node.throughput).toFixed(1)} Mbps</div>
                            <div class="stats">Next Hop: ${node.nexthop}</div>
                        </div>
                    `);
                });

                setTimeout(updateData, 1000);
              })
              .catch(()=> setTimeout(updateData, 1000));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sb=document.querySelector('.sidebar'); applySidebarState(sb);
            updateData(); /* Mesh Live-Daten */
        });
    </script>
</head>
<body>
    {% set active = 'connections' %}
    {% include 'sidebar.html' %}
    <!-- ====== Main content ====== -->
    <main class="main">
        <div class="header">
      <div style="display:flex;flex-direction:column;align-items:flex-start;flex:1;">
        <h1 style="margin:0;">{{ hostname }}</h1>
      </div>
    </div>
        <div class="section">
            <h2>Connections</h2>
            <div class="node-grid">
                {% for mac, node in node_status.items() %}
                {% set is_inactive = node.last_seen > node_timeout %}
                <div class="node-card{% if is_inactive %} inactive{% endif %}">
                    <h3><span class="status-indicator {% if is_inactive %}status-inactive{% else %}status-active{% endif %}"></span>{{ mac }}</h3>
                    <div class="stats">Last Seen: {{ "%.2f"|format(node.last_seen) }}s ago</div>
                    <div class="stats">Throughput: {{ "%.1f"|format(node.throughput) }} Mbps</div>
                    <div class="stats">Next Hop: {{ node.nexthop }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Optional: Platzhalter für Status-Meldungen, falls du hier später Aktionen zulässt -->
        <div id="config-status" class="status-message" aria-live="polite"></div>
    </main>
</body>
</html>
