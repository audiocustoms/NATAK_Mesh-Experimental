<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>OrbisMesh – Mesh Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg:#1a1a1a; --bg-2:#2d2d2d; --bg-3:#111; --text:#fff; --text2:#4caf50;
      --muted:#888; --brand:#4caf50; --danger:#f44336; --border:#444; --border2:#4caf50;
      --sidebar-w:260px; --sidebar-w-collapsed:76px;
    }

    /* Reset / Base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      display:flex; min-height:100vh;
    }
    a{color:inherit;text-decoration:none}

    /* Main area (wie connections.html) */
    .main{flex:1;min-width:0;padding:16px;display:flex;flex-direction:column;gap:24px}
    .header{display:flex;justify-content:space-between;align-items:stretch;gap:12px}
    .logo-header img,.header img{height:60px;object-fit:contain}
    .section{background:var(--bg-2);padding:16px;border-radius:8px;margin:0}
    .local-mac{font-size:14px;color:#999}

    /* Controls für Mesh-Channel & IP */
    .config-controls{display:flex;flex-direction:column;gap:16px}
    .current-config{font-size:16px;padding:8px;background:var(--bg);border-radius:4px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    select,input{background:var(--bg);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:4px}
    button{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}
    button:hover{filter:brightness(.95)}
    button:disabled{background:#666;cursor:not-allowed}

    .status-message{padding:8px;border-radius:4px;display:none}
    .status-success{background:var(--brand);color:#fff}
    .status-error{background:var(--danger);color:#fff}
    .status-info{background:#444;color:#fff}

    @media (max-width: 720px){
      .sidebar{ position: fixed; left: 0; top: 0; }
      /* Content bleibt immer an der Position der eingeklappten Rail */
      .main{ padding: 16px 12px 24px calc(var(--sidebar-w-collapsed) + 12px); }
      /* KEINE Regel für ".sidebar:not(.collapsed) ~ .main" */
    }
    @media (min-width:721px){
      .main{padding:16px 24px 24px 24px}
    }
  </style>

  <script>
    // Channel-to-frequency mapping (2.4 GHz – entspricht Backend)
    const WIFI_CHANNELS = {1:2412,2:2417,3:2422,4:2427,5:2432,6:2437,7:2442,8:2447,9:2452,10:2457,11:2462,12:2467,13:2472,14:2484};

    function showStatus(message, type='info', id='config-status'){
      const el=document.getElementById(id); if(!el) return;
      el.textContent=message; el.className=`status-message status-${type}`; el.style.display='block';
      if(type!=='error'){ setTimeout(()=>{ el.style.display='none'; }, 5000); }
    }

    /* ===== Wi-Fi Mesh Channel ===== */
    function loadMeshConfig(){
      fetch('/api/mesh-config')
        .then(r=>r.json())
        .then(data=>{
          // Aktuelle Werte
          const chEl=document.getElementById('current-channel');
          const frEl=document.getElementById('current-frequency');
          if(chEl) chEl.textContent = data.current_channel;
          if(frEl) frEl.textContent = data.current_frequency;

          // Dropdown füllen
          const select=document.getElementById('channel-select');
          if(!select) return;
          select.innerHTML='';

          const ch24 = (data.available_channels||[]).filter(c=>c<=14);
          const ch5  = (data.available_channels||[]).filter(c=>c>14);

          if(ch24.length){
            const g=document.createElement('optgroup'); g.label='2.4 GHz';
            ch24.forEach(c=>{
              const o=document.createElement('option');
              const mhz=WIFI_CHANNELS[c]||'';
              o.value=c; o.textContent=`Channel ${c}${mhz?` (${mhz} MHz)`:''}`;
              if(c===data.current_channel) o.selected=true;
              g.appendChild(o);
            });
            select.appendChild(g);
          }
          if(ch5.length){
            const g=document.createElement('optgroup'); g.label='5 GHz';
            ch5.forEach(c=>{
              const o=document.createElement('option');
              o.value=c; o.textContent=`Channel ${c}`; // Frequenz unbekannt -> ohne MHz anzeigen
              if(c===data.current_channel) o.selected=true;
              g.appendChild(o);
            });
            select.appendChild(g);
          }
        })
        .catch(()=>showStatus('Failed to load current configuration','error'));
    }

    function changeChannel(){
      const select=document.getElementById('channel-select');
      const btn=document.getElementById('apply-channel');
      const selected=parseInt(select.value,10);
      const current=parseInt(document.getElementById('current-channel').textContent,10);

      if(selected===current) return showStatus('Channel is already set to '+selected,'error');

      if(!confirm(`Change mesh channel to ${selected}? This will restart the system and temporarily disconnect all nodes.`)) return;

      btn.disabled=true; btn.textContent='Applying...';
      showStatus('Changing channel...','info');

      fetch('/api/mesh-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({channel:selected})})
        .then(r=>r.json())
        .then(d=>{
          if(d.success){
            showStatus(d.message||'Channel changed. Reboot required.','success');
            document.getElementById('current-channel').textContent = d.channel;
            document.getElementById('current-frequency').textContent = d.frequency;
          }else{
            showStatus(d.error||'Failed to change channel','error');
            btn.disabled=false; btn.textContent='Apply Channel';
          }
        })
        .catch(()=>{ showStatus('Failed to change channel','error'); btn.disabled=false; btn.textContent='Apply Channel'; });
    }

    /* ===== Node IP Configuration ===== */
    function loadNodeIp(){
      fetch('/api/node-ip')
        .then(r=>r.json())
        .then(d=>{
          const ip=(d&&d.current_ip)||'';
          const cur=document.getElementById('current-ip');
          const inp=document.getElementById('ip-input');
          if(cur) cur.textContent=ip;
          if(inp){ inp.placeholder=ip; }
        })
        .catch(()=>showStatus('Failed to load current IP configuration','error','ip-status'));
    }

    function changeIp(){
      const inp=document.getElementById('ip-input');
      const btn=document.getElementById('apply-ip');
      const cur=document.getElementById('current-ip').textContent.trim();
      const newIp=(inp.value||'').trim();

      const ipRegex=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
      if(!ipRegex.test(newIp)) return showStatus('Invalid IP format. Use: xxx.xxx.xxx.xxx','error','ip-status');

      const oct=newIp.split('.').map(n=>parseInt(n,10));
      if(oct.some(n=>isNaN(n)||n<0||n>255)) return showStatus('IP octets must be 0–255','error','ip-status');

      if(newIp===cur) return showStatus('IP is already set to '+newIp,'error','ip-status');

      if(!confirm(`Change node IP address?\n\nCurrent IP: ${cur}\nNew IP: ${newIp}`)) return;

      btn.disabled=true; btn.textContent='Applying...';
      showStatus('Changing IP address...','info','ip-status');

      fetch('/api/node-ip',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ip:newIp})})
        .then(r=>r.json())
        .then(d=>{
          if(d.success){
            showStatus(d.message||'IP updated.','success','ip-status');
            document.getElementById('current-ip').textContent=d.ip;
            inp.value=''; inp.placeholder=d.ip;
          }else{
            showStatus(d.error||'Failed to change IP','error','ip-status');
          }
          btn.disabled=false; btn.textContent='Apply IP';
        })
        .catch(()=>{ showStatus('Failed to change IP address','error','ip-status'); btn.disabled=false; btn.textContent='Apply IP'; });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Sidebar-State (falls Funktion im Include definiert ist)
      if(typeof applySidebarState==='function'){ const sb=document.querySelector('.sidebar'); applySidebarState(sb); }
      loadMeshConfig();
      loadNodeIp();
    });
  </script>
</head>
<body>
  {% set active = 'mesh-config' %}
  {% include 'sidebar.html' %}

  <main class="main">
    <div class="header">
      <div style="display:flex;flex-direction:column;align-items:flex-start;flex:1;">
        <h1 style="margin:0;">{{ hostname }}</h1>
      </div>
    </div>

    <!-- Wi-Fi Mesh Channel -->
    <div class="section">
      <h2>Wi-Fi Mesh Channel</h2>
      <div class="config-controls">
        <div class="current-config">
          <strong>Current Channel:</strong>
          <span id="current-channel">{{ current_channel }}</span>
          (<span id="current-frequency">{{ current_frequency }}</span> MHz)
        </div>

        <div class="row">
          <label for="channel-select">Change Channel:</label>
          <select id="channel-select"></select>
          <button id="apply-channel" onclick="changeChannel()">Apply Channel</button>
        </div>

        <div class="disclaimer" style="font-size:14px;color:#ff9800;margin-top:8px;">
          Note: Node must be rebooted for channel changes to take effect.
        </div>

        <div id="config-status" class="status-message" aria-live="polite"></div>
      </div>
    </div>

    <!-- Node IP Configuration -->
    <div class="section">
      <h2>Node IP Configuration</h2>
      <div class="config-controls">
        <div class="current-config">
          <strong>Current IP:</strong> <span id="current-ip">{{ current_ip }}</span>
        </div>

        <div class="row">
          <label for="ip-input">Change IP:</label>
          <input id="ip-input" type="text" inputmode="decimal" placeholder="{{ current_ip }}"
                 pattern="^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$" />
          <button id="apply-ip" onclick="changeIp()">Apply IP</button>
        </div>

        <div class="disclaimer" style="font-size:14px;color:#ff9800;margin-top:8px;">
          Note: Node must be rebooted for IP changes to take effect.
        </div>

        <div id="ip-status" class="status-message" aria-live="polite"></div>
      </div>
    </div>
  </main>
</body>
</html>
